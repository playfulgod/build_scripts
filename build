#!/bin/bash

# This script is to make my life easier when building AOKP kangs. It  #
# will build for all the One V devices, but can be modified for       #
# others.                                                             #
# If you want to use this build script you will need to change quite  #
# A few things, including the DIR, sync -jx, device name, upload url, #
# etc. Have fun building!                                             #


# Starting Timer for build
START=$(date +%s)
DEVICE="$1"
ADDITIONAL="$2"
HOME=~/android/aokpjb

# Clean out old builds
cd $HOME
# Sync Source, not too fast though, I don't want to have to restart   #
# it if it hangs.                                                     #
repo sync -j10

# Checking out because it likes to go over my branch
cd device/htc/primoc
git checkout jb
cd ../primou
git checkout jb
cd $HOME

# Grab my cherries
# Adding Primo
cd vendor/htc
git fetch http://gerrit.sudoservers.com/AOKP/vendor_htc refs/changes/97/3797/5 && git cherry-pick FETCH_HEAD
cd ../aokp
git fetch http://gerrit.sudoservers.com/AOKP/vendor_aokp refs/changes/77/3777/6 && git cherry-pick FETCH_HEAD
# Adding Triumph
git fetch https://github.com/rukin5197/vendor_aokp refs/heads/jb && git cherry-pick c4d67956a6eb7b56536e228b6d26ecadaff0cf14
cd $HOME

# Grab the extra features. Make sure to keep these up to date!
# Legacy Graphics
cd frameworks/native
git fetch http://review.cyanogenmod.com/CyanogenMod/android_frameworks_native refs/changes/16/25116/1 && git cherry-pick FETCH_HEAD
cd $HOME
cd hardware/qcom/display
git fetch http://review.cyanogenmod.com/CyanogenMod/android_hardware_qcom_display refs/changes/17/25117/1 && git cherry-pick FETCH_HEAD
git fetch http://review.cyanogenmod.com/CyanogenMod/android_hardware_qcom_display refs/changes/18/25118/1 && git cherry-pick FETCH_HEAD
git fetch http://review.cyanogenmod.com/CyanogenMod/android_hardware_qcom_display refs/changes/19/25119/1 && git cherry-pick FETCH_HEAD
cd $HOME

# Make the builds.
. build/envsetup.sh
lunch aokp_primoc-userdebug
make clobber && make clean
rm -rf aokp_primoc.log aokp_primou.log aokp_triumph.log
make -j7 bacon 2>&1 | tee aokp_primoc.log
lunch aokp_primou-userdebug
make -j7 bacon 2>&1 | tee aokp_primou.log
lunch aokp_triumph-userdebug
make -j7 bacon 2>&1

# Hack for Triumph
device/motorola/triumph/releasetools/triumph_ota_from_target_files -v \
	   -p out/host/linux-x86 \
	   -k build/target/product/security/testkey \
           --backup=false \
	   --override_device=triumph,WX435,fb0 \
	   out/target/product/triumph/obj/PACKAGING/target_files_intermediates/aokp_triumph-target_files-eng.gannon5197.zip out/target/product/triumph/aokp_triumph-ota-eng.gannon5197.zip && ./vendor/aokp/tools/squisher | tee aokp_triumph.log

# Set variables to grab zip names
PRIMOC=$(tail aokp_primoc.log | cut -f3 -d ' ' | cut -f1 -d ' ' | sed -e '/^$/ d')
PRIMOU=$(tail aokp_primou.log | cut -f3 -d ' ' | cut -f1 -d ' ' | sed -e '/^$/ d')
TRIUMPH=$(tail aokp_triumph.log | cut -f3 -d ' ' | cut -f1 -d ' ' | sed -e '/^$/ d')

REALDATE=`date +%F`

#Upload to goo
scp -P 2222 $PRIMOC gannon5197@upload.goo.im:~/public_html/aokp/primoc/nightlies/
scp -P 2222 $PRIMOU gannon5197@upload.goo.im:~/public_html/aokp/primou/nightlies/
scp -P 2222 $TRIUMPH gannon5197@upload.goo.im:~/public_html/aokp/triumph/nightlies/

END=$(date +%s)
ELAPSED=$((END - START))
E_MIN=$((ELAPSED / 60))
E_SEC=$((ELAPSED - E_MIN * 60))
printf "Elapsed: "
[ $E_MIN != 0 ] && printf "%d min(s) " $E_MIN
printf "%d sec(s)\n" $E_SEC

#All done!
echo "finished with the build! Don't forget to tell XDA!"
